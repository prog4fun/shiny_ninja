# encoding: UTF-8

<div class="page-header">
  <h1>
    <%= t("activerecord.models.reports")%>
    <% if @evaluate_page %>
      <small><%= t("activerecord.models.project") %>: <strong><%= @projects_user.project.name %></strong>, <%= t("labels.roles.timetracker") %>: <strong><%= @projects_user.project.customer.user.firstname %> <%= @projects_user.project.customer.user.lastname %></strong></small>  
    <% end %>
  </h1>
</div>
<div class="row">
  <div class="col-md-2 col-md-offset-7">
    <div class="btn-group">
      <% if @reports.present?  %>
        <a class="btn btn-info" href="<%= url_for(:action => "index", :data => params[:search], :projects_user => params[:projects_user], :format => :csv) %>" target="_blank">
          <span class="glyphicon glyphicon-cloud-download" alt="<%= t("labels.actions.download") %>" title="<%= t("labels.actions.download_csv_explanation") %>"></span>
          <%= t("labels.actions.download") %>
        </a>
      <% end %>
      <% if @evaluate_page %>
        <%= link_to_destroy_evaluator(:controller => "projects_users", :action => "show", :id => @projects_user.id, :project_id => @reports_all.first.project.id) %>
        <a class='btn btn-danger' href='<%= url_for(:controller => "projects_users", :action => "show", :id => @projects_user.id)%>' data-confirm='<%= t("labels.actions.confirm") %>' data-method='delete' rel='nofollow'>
          <span class="glyphicon glyphicon-off" alt="<%= t("activerecord.actions.projects_user.destroy") %>" title="<%= t("activerecord.actions.projects_user.destroy_explanation") %>"></span>
          <%= t("activerecord.actions.projects_user.destroy") %>
        </a>
      <% else %>
        <%= link_to_new(:controller => "reports", :action => "new") %>
      <% end %>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-9">
    <div class="table-responsive">
      <table class="table table-bordered table-hover table-condensed">
        <tr>
          <th><%= t("labels.report.date") %></th>
          <th><%= t("activerecord.models.project") %></th>
          <th><%= t("activerecord.models.service") %></th>
          <% unless @evaluate_page %>
            <th><%= t("activerecord.attributes.report.wage") %></th>
          <% end %>
          <th><%= t("labels.report.duration") %></th>
          <th style="display: none;"></th>
        </tr>

        <% if @reports.empty? %>
          <tr><td colspan="<%= @evaluate_page ? 5:6 %>" class="text-muted"><%= t("labels.universe.no_entry") %> </td></tr>
          <% if current_user.is? :project_evaluator %>
            <tr><td colspan="5" class="text-muted"><%= t("labels.report.no_projects_as_evaluator")%> </td></tr>
          <% end %>
        <% else %>
        <% date_prev = "" %>
          <% @reports.each do |report| %>
            <tr class="report report<%= report.id %>" rel="popover" data-placement="top" data-toggle="popover">
              <% if report.date == date_prev %>
              	<td></td>
              <% else %>
              	<td ><%= report.date%></td>
              <% end %>
              <% date_prev = report.date %>
              <td><%= truncate(report.project.name, :length => 40) %></td>
              <td><%= truncate(report.service.name, :length => 40) %></td>
              <% unless @evaluate_page %>
                <td><%= report.get_wage %></td>
              <% end %>
              <td><%= report.get_duration %></td>
              <td style="display: none;" class="popover_report<%= report.id %>">
                <div style="margin-bottom: 25px;">
                  <b><%= t("activerecord.models.customer") %></b>: <%= get_customer_of_report(report) %><br>
                  <b><%= t("labels.report.income") %></b>: <%= report.get_income %><br>
                  <b><%= t("labels.universe.comment") %></b>: <%= truncate(report.comment, :length => 111) %>
                  </div>
                  <div style="text-align: center;">
                  <%= link_to_show(:controller => "reports", :action => "show", :id => report.id, :projects_user => params[:projects_user]) %>
                  <% unless @evaluate_page %><%= link_to_edit(:controller => "reports", :action => "edit", :id => report.id) %><% end %>
                  <% unless @evaluate_page %><%= link_to_destroy(:controller => "reports", :action => "show", :id => report.id) %><% end %>
                </div>
              </td>

            </tr>
          <% end %>
        <% end %>
      </table>
      <div id="popover_container"></div>
    </div>

    <div class="col-md-offset-4"><%= paginate @reports %></div>
  </div>

  <div class="col-md-3">
    <%= render "sidebar" %>
  </div>

</div>